# 可扩展性

如果不做任何采样，调用链追踪系统需要处理的数据与全站的请求总量正相关。假如全站所有请求平均要经过 20 个服务处理，那么调用链追踪系统将需要承担全站请求总量 20 倍压力，因此其架构设计上的每一层都需要支持横向可扩展。通常可扩展性包含三部分：数据摄入 (ingestion)、数据处理以及数据持久化。在设计上每一部分支持扩展性的同时，还需要考虑过载控制。既要防止在峰值流量下埋点及上报对在线服务的影响，也需要考虑调用链追踪后端各模块的承载能力。

**数据摄入**常见有两种方式，一种是上报方直接将数据通过 HTTP 或 RPC 请求发送到调用链追踪系统后端；另一种是上报方将数据线投递到消息中间件。前者将过载控制放在调用链追踪后端中，后者将过载控制建立在消息中间件削峰填谷的能力之上。

**数据处理**既要支持数据分片，又不能影响数据处理的正确性。通常数据处理需要获取同一调用链的所有数据，因此通过 TraceID 分片是天然的选择。但因为分布式系统中的不确定性，我们在任何时候都不能保证 "某调用链的所有数据已经到达"，因此引入合理的超时机制以及有限制的本地缓存十分必要。超时机制保证程序不会无限等待，本地缓存保证资源消耗不会无限增加。如果要保证数据不丢，还需要引入合理的补偿机制。

**数据持久化**一般依赖于后端使用的存储服务的可扩展性。通过时间、租户以及计算执行单元等信息对数据分片。另外调用链数据的重要性通常会随着时间的推移而变低，因此合理的保留 (retention) 机制可以避免占用不必要的存储资源。